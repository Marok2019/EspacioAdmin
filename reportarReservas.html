<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descargar Log de Reservas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="reportarReservas.css">
</head>

<body>
    <div class="header-container d-flex align-items-center">
        <img src="https://i.ibb.co/FW5SBG3/logo-no-background.png" alt="Logo" class="header-logo">
        <button type="button" class="btn btn-danger logout-button">Cerrar Sesión</button>
    </div>

    <div class="container mt-5">
        <h1 class="text-center text-white mb-4">Descargar Log de Reservas</h1>

        <div class="card">
            <div class="card-header">Filtros de búsqueda</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="condominiumDropdown" class="form-label text-white">Seleccione el condominio:</label>
                        <select class="form-select" id="condominiumDropdown" aria-label="Condominio Selection" required>
                            <option selected disabled>Seleccione un condominio...</option>
                            <option value="condominio1">Condominio 1</option>
                            <option value="condominio2">Condominio 2</option>
                            <option value="condominio3">Condominio 3</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="commonSpaceDropdown" class="form-label text-white">Seleccione el espacio
                            común:</label>
                        <select class="form-select" id="commonSpaceDropdown" aria-label="Espacio común Selection"
                            required>
                            <option selected disabled>Seleccione un espacio común...</option>
                            <option value="space1">Sala de reuniones</option>
                            <option value="space2">Área de descanso</option>
                            <option value="space3">Salón de eventos</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <label for="rutInput" class="form-label text-white">Buscar por RUT:</label>
                    <input type="text" class="form-control" id="rutInput" placeholder="Ingrese el RUT">
                </div>
                <button type="button" class="btn btn-primary" id="searchButton">Buscar</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Resultados de la búsqueda</div>
            <div class="card-body">
                <div id="searchResults"></div>
                <button type="button" class="btn btn-success" id="downloadButton">Descargar log</button>
            </div>
        </div>
    </div>

    <footer class="bg-dark py-3 mt-5">
        <div class="container">
            <p class="text-center text-white">&copy; <span id="current-year"></span> Todos los derechos reservados</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('current-year').textContent = new Date().getFullYear();

        const searchButton = document.getElementById('searchButton');
        const downloadButton = document.getElementById('downloadButton');
        const searchResults = document.getElementById('searchResults');

        searchButton.addEventListener('click', async () => {
            const condominium = document.getElementById('condominiumDropdown').value;
            const commonSpace = document.getElementById('commonSpaceDropdown').value;
            const rut = document.getElementById('rutInput').value;

            // Simulate API call (replace with actual API call)
            const response = await fetch(`/api/bookings`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    condominio: condominium,
                    espacio_comun: commonSpace,
                    rut: rut
                })
            });

            if (response.ok) {
                const bookings = await response.json();
                displaySearchResults(bookings);
                downloadButton.disabled = false;
            } else {
                searchResults.innerHTML = "No se encontraron reservas que coincidan con los criterios de búsqueda.";
                downloadButton.disabled = true;
            }
        });

        downloadButton.addEventListener('click', () => {
            // Simulate log download (replace with actual download logic)
            alert("Descargando log de reservas...");
        });

        function displaySearchResults(bookings) {
            let html = "";
            if (bookings.length === 0) {
                html = "No se encontraron reservas que coincidan con los criterios de búsqueda.";
            } else {
                html += "<h5>Reservas encontradas:</h5>";
                html += "<ul class='list-group'>";
                bookings.forEach(booking => {
                    html += `
                        <li class='list-group-item'>
                            <strong>ID Reserva:</strong> ${booking.id_reserva}<br>
                            <strong>Condominio:</strong> ${booking.condominio}<br>
                            <strong>Espacio común:</strong> ${booking.espacio_comun}<br>
                            <strong>Fecha y hora inicio:</strong> ${new Date(booking.fecha_inicio).toLocaleString()}<br>
                            <strong>Fecha y hora término:</strong> ${new Date(booking.fecha_fin).toLocaleString()}<br>
                            <strong>RUT:</strong> ${booking.rut}
                        </li>
                    `;
                });
                html += "</ul>";
            }
            searchResults.innerHTML = html;
        }
    </script>
</body>

</html>